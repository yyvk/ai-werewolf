# 音频流式播放测试指南

## 快速测试步骤

### 1. 启动后端

```bash
cd backend  # 如果有的话，或者在项目根目录
python -m src.web.api
```

### 2. 启动前端

```bash
cd frontend
npm run dev
```

### 3. 测试流程

1. 打开浏览器控制台（F12）
2. 访问游戏页面
3. 开始游戏
4. 观察控制台输出

### 4. 预期的控制台输出

#### 后端输出示例

```
🎵 开始TTS生成: 玩家1, 文本长度=50, 音色=Cherry
🔍 音频格式检测 (玩家1): 前8字节=49 44 33 04 00 00 00 00
✅ 检测到 MP3 格式
📦 发送音频块 #1 (玩家1): 4096 bytes
📦 发送音频块 #2 (玩家1): 4096 bytes
📦 发送音频块 #3 (玩家1): 4096 bytes
✅ TTS生成完成 (qwen3-tts-flash): 玩家1, 共3块, 总大小=12288 bytes
```

#### 前端输出示例

```
📨 收到消息: {"type": "speech_start", "player_id": 1}
📨 收到消息: {"type": "audio_chunk", "player_id": 1, "audio_data": "..."}
🔊 开始流式播放音频...
🔊 准备播放: 玩家1 的流式语音, 音频块数: 3
🔍 音频数据大小: 12288 bytes
🔍 音频数据前8字节: 49 44 33 04 00 00 00 00
✅ 检测到 MP3 格式
🎵 使用 Web Audio API 解码 MP3 格式...
✅ 解码成功: 时长=2.50秒, 采样率=16000Hz, 声道=1
▶️ 正在播放: 玩家1
✅ 播放完成: 玩家1
```

### 5. 验证要点

✅ **后端**:
- [x] 检测到正确的音频格式（MP3/WAV）
- [x] 成功发送多个音频块
- [x] 显示总音频大小和块数

✅ **前端**:
- [x] 成功接收所有音频块
- [x] 正确检测音频格式
- [x] Web Audio API 成功解码
- [x] 播放完成无错误

### 6. 常见问题排查

#### 问题 1: 没有音频播放

**检查清单**:
- [ ] 确认 `TTS_ENABLED=true` 在 `.env` 文件中
- [ ] 确认 DashScope API Key 已配置
- [ ] 检查网络连接
- [ ] 查看控制台是否有错误

#### 问题 2: 播放失败错误

**检查清单**:
- [ ] 查看控制台错误代码（1-4）
- [ ] 确认音频格式检测是否正确
- [ ] 检查浏览器是否支持 Web Audio API
- [ ] 尝试其他浏览器（推荐 Chrome/Edge）

#### 问题 3: 音频格式不匹配

**解决方案**:
```
❌ 错误: 4: MEDIA_ERR_SRC_NOT_SUPPORTED - 不支持的格式

✅ 解决:
1. 查看后端日志，确认实际格式
2. Web Audio API 会自动处理
3. 如果持续失败，检查音频数据是否完整
```

## 高级测试

### 测试不同音频格式

1. **修改配置** (`config/default.json`):
```json
{
  "tts": {
    "providers": {
      "dashscope": {
        "format": "wav"  // 仅用于旧模型
      }
    }
  }
}
```

2. **观察格式检测**:
- MP3: `49 44 33` 或 `FF Ex`
- WAV: `52 49 46 46`
- OGG: `4F 67 67 53`

### 测试不同语速和音高

```bash
# 在 .env 中设置
TTS_SPEED=1.5  # 加快语速
TTS_PITCH=1.2  # 提高音调
```

### 性能测试

观察控制台输出的指标：

- **音频块数**: 越多表示流式效果越好
- **每块大小**: 通常 2-8 KB
- **总音频时长**: 与文本长度成正比
- **解码时间**: 应该很快（< 100ms）

## 成功标准

✅ **基本功能**:
- 音频能正常播放
- 声音清晰，无杂音
- 播放完整，无中断

✅ **流式体验**:
- 多个音频块逐步接收
- 延迟低（< 1秒开始播放）
- 播放流畅

✅ **错误处理**:
- 格式检测准确
- Web Audio API 失败能自动回退
- 错误信息详细清晰

---

**测试完成后**，如果一切正常，您应该能听到流畅的语音播放！ 🎉


