# 流式对话输出功能

## 功能概述

本更新为AI狼人杀游戏添加了**流式输出**功能，大幅提升了用户观看和游戏体验。

## 主要改进

### 1. 后端改进 (SSE Server-Sent Events)

- **新增流式API接口**: `/api/games/{game_id}/stream-round`
- **实时推送游戏事件**:
  - 回合开始通知
  - 阶段切换（讨论/投票）
  - AI发言流式输出（逐字显示）
  - 投票结果实时推送
  - 淘汰事件通知
  - 游戏结束提示

### 2. Agent 流式发言

- **新增方法**: `speak_stream()` - 支持异步流式生成
- **LangChain集成**: 使用 `astream()` API 实现真实的流式输出
- **降级处理**: 当LLM调用失败时，自动切换到降级方案

### 3. 前端体验优化

#### 打字机效果
- AI发言逐字显示，模拟真实打字效果
- 光标闪烁动画，增强视觉体验

#### 实时状态显示
- 显示当前发言者信息（姓名、角色）
- "正在说话..." 动态提示
- 自动滚动到最新消息

#### 丰富的视觉反馈
- 不同事件类型使用不同配色：
  - 🎮 **系统消息** - 蓝色
  - 💬 **发言** - 紫色
  - 🗳️ **投票** - 橙色
  - 💀 **淘汰** - 红色
  - 🎉 **游戏结束** - 绿色

#### 动画效果
- 滑入动画：新事件从左侧滑入
- 脉冲动画：正在发言的消息有呼吸灯效果
- 淡入淡出：状态指示器柔和变化

## 使用方式

### 1. 启动后端服务

```bash
python main.py
```

### 2. 启动前端服务

```bash
cd frontend
npm run dev
```

### 3. 使用流式功能

1. 创建游戏
2. 开始游戏
3. 点击"▶️ 下一轮"按钮
4. 观看AI实时流式对话

## 技术实现

### 后端技术栈
- **FastAPI StreamingResponse**: 实现SSE流式传输
- **AsyncGenerator**: Python异步生成器
- **LangChain astream**: 流式调用LLM

### 前端技术栈
- **EventSource API**: 接收SSE事件流
- **Vue 3 Composition API**: 响应式状态管理
- **CSS动画**: 打字机效果、脉冲动画等

### 数据流

```
LLM (流式生成)
    ↓
Agent.speak_stream() 
    ↓
FastAPI StreamingResponse (SSE)
    ↓
EventSource (前端接收)
    ↓
Vue响应式更新
    ↓
打字机效果展示
```

## 性能优化

1. **按需加载**: 只在需要时建立SSE连接
2. **自动断开**: 回合结束后自动关闭连接
3. **错误恢复**: 连接失败时自动重新加载游戏状态
4. **节流控制**: 控制打字速度（0.05秒/字符）避免过快

## 兼容性

- 保留了原有的非流式API `/api/games/{game_id}/next-round`
- 向下兼容旧版前端代码
- 支持降级到静态显示模式

## 未来扩展

- [ ] 添加语音播报功能
- [ ] 支持多语言流式输出
- [ ] 添加表情和头像动画
- [ ] 支持用户自定义打字速度
- [ ] 添加消息重放功能

## 演示

启动游戏后，你将看到：

1. ✨ **平滑的动画过渡**
2. 💬 **逐字显示的AI对话**
3. 🎯 **实时的游戏状态更新**
4. 🎨 **丰富的视觉反馈**

体验升级，让AI狼人杀游戏更加生动有趣！








